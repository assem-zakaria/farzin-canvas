<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SVG Editor with Zoom, Drag, Undo</title>
  <style>


    #farzin-drawing-tool {
      padding: 30px;
      font-family: monospace;
    }

    canvas { 
      display: none; 
      margin: 10px 0; 
      border: 1px solid #ccc; 
    }

    #svgContainer svg path:hover { 
      stroke: red; 
      stroke-width: 1;
      cursor: pointer;
    }

    #svgContainer {
      position: relative;
      width: 100%;
      height: 85vh;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.1);
      margin-top: 20px;
      border-radius: .25rem;
    }

    #svgOutput {
      width: 100%;
      height: 100%;
      cursor: grab;
    }

    #svgContainer #tool-help {
      position: absolute;
      left: 20px;
      bottom: 20px;
      display: flex;
      align-items: center;
      gap: 5px;
      box-shadow: rgba(0, 0, 0, 0.16) 0px 3px 6px, rgba(0, 0, 0, 0.23) 0px 3px 6px;
      border-radius: 5px;
      padding: 4px 7px;
      font-size: 10px;
    }

    #svgContainer #tool-help svg {
      width: 20px;
      height: 20px;
    }

    #progressBarContainer {
      display: none;
      margin: 10px 0;
      width: 100%;
      max-width: 600px;
      height: 10px;
      background-color: #eee;
      border-radius: 3px;
      overflow: hidden;
    }

    #progressBar {
      width: 0%;
      height: 100%;
      background-color: #5bdfe7;
      transition: width 0.1s ease;
    }

    #control-panel {
      display: flex;
      gap: 20px;
    }

    #control-panel button {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      align-items: center;
      background-color: #FFFFFF;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: .25rem;
      box-shadow: rgba(0, 0, 0, 0.02) 0 1px 3px 0;
      box-sizing: border-box;
      color: rgba(0, 0, 0, 0.85);
      cursor: pointer;
      justify-content: center;
      padding: calc(.875rem - 1px) calc(1.5rem - 1px);
      position: relative;
      text-decoration: none;
      transition: all 250ms;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      vertical-align: baseline;
      font-family: monospace;
    }

    #control-panel button:hover {
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: rgba(0, 0, 0, 0.1) 0 4px 12px;
      color: rgba(0, 0, 0, 0.65);
    }

    #control-panel button:active {
      background-color: #F0F0F1;
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: rgba(0, 0, 0, 0.06) 0 2px 4px;
      color: rgba(0, 0, 0, 0.65);
      transform: translateY(0);
    }

    #control-panel button svg {
      pointer-events: none;
      width: 18px;
      height: 18px;
    }

    #control-panel #traceButton {
      display: none;
    }


    #texture-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0px 15px;
      border-radius: .25rem;
      box-shadow: rgba(0, 0, 0, 0.06) 0px 2px 4px 0px inset;
    }

    .zoom-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 10;
    }

    .zoom-buttons button {
      display: flex;
      gap: 5px;
      align-items: center;
      background-color: #FFFFFF;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: .25rem;
      box-shadow: rgba(0, 0, 0, 0.02) 0 1px 3px 0;
      box-sizing: border-box;
      color: rgba(0, 0, 0, 0.85);
      cursor: pointer;
      justify-content: center;
      position: relative;
      text-decoration: none;
      transition: all 250ms;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      vertical-align: baseline;
      height: 40px;
      width: 40px;
    }

    .zoom-buttons button:hover {
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: rgba(0, 0, 0, 0.1) 0 4px 12px;
      color: rgba(0, 0, 0, 0.65);
    }

    .zoom-buttons button:active {
      background-color: #F0F0F1;
      border-color: rgba(0, 0, 0, 0.15);
      box-shadow: rgba(0, 0, 0, 0.06) 0 2px 4px;
      color: rgba(0, 0, 0, 0.65);
      transform: translateY(0);
    }

    #textureSelCont {
/*       border: 1px blue dashed; */
    }

    .texture-dropdown {
      display: flex;
      flex-direction: column;
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: all 0s ease-in-out;
      transform: translateY(-10px);
      border-radius: 7px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: rgba(0, 0, 0, 0.02) 0 1px 3px 0;
      padding: 10px 0px;
    }

    .texture-dropdown.active {
      opacity: 1;
      pointer-events: all;
      transform: translateY(5px);
      transition: all 200ms cubic-bezier(0.455, 0.030, 0.515, 0.955);
    }

    .texture-option {
      padding: 4px 8px;
      cursor: pointer;
    }

    .texture-option:hover {
      background-color: #d1d1d1;
    }

    .texture-option.active {
      background: #007bff;
      color: white;
    }


  </style>
</head>

<body>


<div id="farzin-drawing-tool">

  <div id="control-panel">

    <button onclick="document.getElementById('imageUpload').click()">
      Upload Line Art
      <svg xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" fill="#000000" width="128" height="128" viewBox="0 0 512 512">
        <path d="M173.73,159.06l-21.39-21.4L256,34,359.66,137.66l-21.39,21.4L271.13,91.92V408.67H240.87V91.92ZM445.4,351.31v93a3.6,3.6,0,0,1-3.47,3.46H69.66a3.29,3.29,0,0,1-3.06-3.46v-93H36.34v93A33.56,33.56,0,0,0,69.66,478H441.93a33.76,33.76,0,0,0,33.73-33.72v-93Z"/>
      </svg>
    </button>
    <input type="file" id="imageUpload" accept="image/png, image/jpeg" style="display:none" />

    <button id="traceButton">Trace Image</button>

    <div id="textureSelCont">
      <button id="chooseTextureButton">
        Choose Stone
        <svg xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 512 512">
          <path fill="#000000" d="M18.08 23l.1 18H494V23H18.08zM254.3 54.93L133 61.6l30.1 68.5 98.1-3.6-6.9-71.57zm115.9.28l-92.9.53 3 71.96 96.8-.9-6.9-71.59zM18.23 56.43l.35 74.67 72.27-2.4 24.35-72.27H18.23zM393 64.24l-.5 47.16 15.7 21.5 85.8-6.3V64.93l-101-.69zM120.8 84.68l-17.6 49.82 41.1-1-8.2-34.02-15.3-14.8zm354.7 56.02l-4 75.5 22.5-.6v-74.9h-18.5zm-25.7 3.5l-97.3 10.7L346 219l110.7-3.2-6.9-71.6zm-243.8.7l-4 75.5 126.1-3.9 7-71.1-129.1-.5zm-145.33 2.7l-3.9 75.5 126.13-3.9-6.9-71.6H60.67zm-42 1.5l.33 72.4 24.77-.8-6.9-71.6h-18.2zm278.93 84.3L276 277.2l2.1 42 128.7-1.9-7.6-79.7-101.6-4.2zm-40.2 1.4l-127.2 6 8 69.5 124.7 6.6-5.5-82.1zm236.6 3.1l-66.5 2.9-7.5 75.8 74-5.2v-73.5zm-474.89 7l.31 65.8 100.78-3.1-6.9-62.7H19.11zm470.29 81.2l-115.9 10.5-3.3 65 121.5-3.5-2.3-72zm-422.36 4.1l-47.52 2 .34 72.9 51.1-1.3-3.92-73.6zm17.84 0l3.98 68.5 138.64 9.6-3-78.1H84.88zm161.22 4.3l-5.5 69 107.5 5.4-1-73.5-101-.9zm185.4 81.1l-4 75.5 66.5-.6v-73.8l-62.5-1.1zm-9.8 1.2l-39 3.6 27.4 28 11.6-31.6zm-399.46 1.8l-2.13 40.6.16 34.8H145.4v-68.9l-46.56-2.5-18.4 14L68.56 421l-46.32-2.4zm247.96.3l-111.3 1.5 3.5 72.5 114.7-2.4-6.9-71.6zm101.2 4.3l-72.2 5.9-8.9 62.1 125.6.6-6.2-27-38.3-41.6z"/>
        </svg>
      </button>
      <input type="file" id="textureUpload" accept="image/*" style="display:none" />
      <div id="textureDropdown" class="texture-dropdown"></div>
    </div>

    <div id="texture-controls">
      <label for="textureScale">Texture Scale:</label>
      <input type="number" id="textureScale" min="10" max="4500" value="1000">
    </div>

    <button id="downloadButton">
      Download PNG
      <svg xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" fill="#000000" width="128" height="128" viewBox="0 0 512 512">
        <path d="M256,409.7,152.05,305.75,173.5,284.3l67.33,67.32V34h30.34V351.62L338.5,284.3,360,305.75ZM445.92,351v93.22a3.61,3.61,0,0,1-3.47,3.48H69.15a3.3,3.3,0,0,1-3.07-3.48V351H35.74v93.22A33.66,33.66,0,0,0,69.15,478h373.3a33.85,33.85,0,0,0,33.81-33.82V351Z"/>
      </svg>
    </button>
  </div>

  <div id="progressBarContainer">
    <div id="progressBar"></div>
  </div>

  <canvas id="imageCanvas"></canvas>

  <div id="svgContainer">
    <div class="zoom-buttons">
      <button id="zoomIn">+</button>
      <button id="zoomOut">âˆ’</button>
    </div>
    <svg id="svgOutput"></svg>

    <div id="tool-help">
      <svg xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" fill="#000000" width="128" height="128" viewBox="0 0 32 32">
        <path d="M 16 3 C 8.832031 3 3 8.832031 3 16 C 3 23.167969 8.832031 29 16 29 C 23.167969 29 29 23.167969 29 16 C 29 8.832031 23.167969 3 16 3 Z M 16 5 C 22.085938 5 27 9.914063 27 16 C 27 22.085938 22.085938 27 16 27 C 9.914063 27 5 22.085938 5 16 C 5 9.914063 9.914063 5 16 5 Z M 15 10 L 15 12 L 17 12 L 17 10 Z M 15 14 L 15 22 L 17 22 L 17 14 Z"/>
      </svg>
      <b>Undo:</b> Ctrl+z, <b>Zoom In/Out:</b> Scroll Up/Down, <b>Download:</b> Ctrl+s 
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/jankovicsandras/imagetracerjs@1.2.6/imagetracer_v1.2.6.js"></script>
<script>
  const imageUpload = document.getElementById('imageUpload');
  const traceButton = document.getElementById('traceButton');
  const downloadButton = document.getElementById('downloadButton');
  const canvas = document.getElementById('imageCanvas');
  const ctx = canvas.getContext('2d');
  const svgOutput = document.getElementById('svgOutput');
  const textureUpload = document.getElementById('textureUpload');
  const textureScaleSlider = document.getElementById('textureScale');
  const progressBarContainer = document.getElementById('progressBarContainer');
  const progressBar = document.getElementById('progressBar');
  const svgContainer = document.getElementById('svgContainer');
  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const chooseTextureButton = document.getElementById('chooseTextureButton');
  const textureDropdown = document.getElementById('textureDropdown');

  let currentImage = null;
  let texturePattern = null;
  let textureScale = parseInt(textureScaleSlider.value);
  let zoomLevel = 1;
  let isDragging = false;
  let dragStart = { x: 0, y: 0 };
  let viewBox = [0, 0, 600, 600];
  let undoStack = [];
  let dragMoved = false;

  const predefinedTextures = Array.from({ length: 8 }, (_, i) => `textures/seamless-texture-${i + 1}.jpg`);
  let selectedTextureIndex = 0;

  function loadDefaultTexture() {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.getContext('2d').drawImage(img, 0, 0);
      texturePattern = canvas.toDataURL('image/jpeg');
    };
    img.src = predefinedTextures[selectedTextureIndex];
  }

  function updateTextureDropdown() {
    textureDropdown.innerHTML = '';
    predefinedTextures.forEach((src, index) => {
      const option = document.createElement('div');
      option.className = 'texture-option' + (index === selectedTextureIndex ? ' active' : '');
      option.textContent = `Texture ${index + 1}`;
      option.onclick = () => {
        selectedTextureIndex = index;
        loadDefaultTexture();
        textureDropdown.classList.remove('active');
        updateTextureDropdown();
      };
      textureDropdown.appendChild(option);
    });

    const customOption = document.createElement('div');
    customOption.className = 'texture-option';
    customOption.textContent = 'Add Custom Texture (Square High Res JPG)';
    customOption.onclick = () => {
      textureUpload.click();
      textureDropdown.classList.remove('active');
    };
    textureDropdown.appendChild(customOption);
  }

  chooseTextureButton.addEventListener('click', () => {
    textureDropdown.classList.toggle('active');
  });

  imageUpload.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          currentImage = img;
          traceButton.click();
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }
  });

  traceButton.addEventListener('click', () => {
    if (!currentImage) return;
    progressBarContainer.style.display = 'block';
    progressBar.style.width = '10%';

    setTimeout(() => {
      const tracedSVG = ImageTracer.imagedataToSVG(
        ctx.getImageData(0, 0, canvas.width, canvas.height),
        {
          corsenabled: true,
          scale: 1,
          pathomit: 1,
          colorsampling: 0,
          numberofcolors: 2,
          colorquantcycles: 3,
          blurradius: 0,
          blurdelta: 20
        }
      );

      progressBar.style.width = '60%';

      const parser = new DOMParser();
      const doc = parser.parseFromString(tracedSVG, "image/svg+xml");
      const paths = doc.querySelectorAll('path');

      svgOutput.innerHTML = '';
      viewBox = [0, 0, canvas.width, canvas.height];
      svgOutput.setAttribute('viewBox', viewBox.join(' '));
      svgOutput.setAttribute('preserveAspectRatio', 'xMidYMid meet');

      paths.forEach((p) => {
        p.setAttribute('fill', '#ffffff');
        p.setAttribute('stroke', '#000000');
        svgOutput.appendChild(p);
      });

      progressBar.style.width = '100%';
      setTimeout(() => {
        progressBarContainer.style.display = 'none';
        progressBar.style.width = '0%';
      }, 500);
    }, 100);
  });

  svgOutput.addEventListener('mousedown', e => {
    isDragging = true;
    dragMoved = false;
    svgOutput.style.cursor = 'grabbing';
    dragStart = { x: e.clientX, y: e.clientY };
  });

  svgOutput.addEventListener('mousemove', e => {
    if (!isDragging) return;
    const dx = (e.clientX - dragStart.x) * (viewBox[2] / svgOutput.clientWidth);
    const dy = (e.clientY - dragStart.y) * (viewBox[3] / svgOutput.clientHeight);
    viewBox[0] -= dx;
    viewBox[1] -= dy;
    svgOutput.setAttribute('viewBox', viewBox.join(' '));
    dragStart = { x: e.clientX, y: e.clientY };
    dragMoved = true;
  });

  svgOutput.addEventListener('mouseup', () => {
    isDragging = false;
    svgOutput.style.cursor = 'grab';
  });

  svgOutput.addEventListener('mouseleave', () => {
    isDragging = false;
    svgOutput.style.cursor = 'grab';
  });

  svgContainer.addEventListener('wheel', e => {
    e.preventDefault();
    const zoomFactor = e.deltaY < 0 ? 0.9 : 1.1;
    zoomLevel *= zoomFactor;
    viewBox[2] *= zoomFactor;
    viewBox[3] *= zoomFactor;
    svgOutput.setAttribute('viewBox', viewBox.join(' '));
  });

  zoomInBtn.addEventListener('click', () => {
    viewBox[2] *= 0.9;
    viewBox[3] *= 0.9;
    svgOutput.setAttribute('viewBox', viewBox.join(' '));
  });

  zoomOutBtn.addEventListener('click', () => {
    viewBox[2] *= 1.1;
    viewBox[3] *= 1.1;
    svgOutput.setAttribute('viewBox', viewBox.join(' '));
  });

  svgOutput.addEventListener('click', e => {
    if (dragMoved) return;
    if (e.target.tagName === 'path') {
      const target = e.target;
      const previous = target.getAttribute('fill');
      if (texturePattern) {
        const id = `pattern-${Math.random().toString(36).substr(2, 5)}`;
        const defs = svgOutput.querySelector('defs') || svgOutput.insertBefore(
          document.createElementNS('http://www.w3.org/2000/svg', 'defs'),
          svgOutput.firstChild
        );

        const pattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
        pattern.setAttribute('id', id);
        pattern.setAttribute('patternUnits', 'userSpaceOnUse');
        pattern.setAttribute('width', textureScale);
        pattern.setAttribute('height', textureScale);

        const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
        img.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', texturePattern);
        img.setAttribute('width', textureScale);
        img.setAttribute('height', textureScale);
        pattern.appendChild(img);
        defs.appendChild(pattern);

        target.setAttribute('fill', `url(#${id})`);
        undoStack.push({ el: target, fill: previous });
      }
    }
  });

  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key.toLowerCase() === 'z') {
      const last = undoStack.pop();
      if (last) last.el.setAttribute('fill', last.fill);
    }
  });

  textureUpload.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        texturePattern = reader.result;
        selectedTextureIndex = -1;
        updateTextureDropdown();
      };
      reader.readAsDataURL(file);
    }
  });

  textureScaleSlider.addEventListener('input', e => {
    textureScale = parseInt(e.target.value);
  });

  downloadButton.addEventListener('click', () => {
    const svgData = new XMLSerializer().serializeToString(svgOutput);
    const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(svgBlob);

    const img = new Image();
    img.onload = () => {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = 1000;
      tempCanvas.height = 1000 * img.height / img.width;
      const tctx = tempCanvas.getContext('2d');
      tctx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
      const link = document.createElement('a');
      link.download = 'output.png';
      link.href = tempCanvas.toDataURL('image/png');
      link.click();
    };
    img.src = url;
  });

  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key.toLowerCase() === 's') {
      e.preventDefault();
      downloadButton.click();
    }
  });

  // Init
  loadDefaultTexture();
  updateTextureDropdown();
</script>
</body>
</html>